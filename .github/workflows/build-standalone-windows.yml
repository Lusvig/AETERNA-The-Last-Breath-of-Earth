name: Build Windows Standalone

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub Release'
        required: false
        default: 'true'

env:
  UE_VERSION: 5.4
  PROJECT_NAME: Aeterna
  GAME_NAME: AETERNA_Day47_FirstContact

jobs:
  build-windows:
    name: Build Windows Shipping
    runs-on: windows-latest
    timeout-minutes: 240
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0
      
      - name: Checkout LFS Objects
        run: git lfs checkout
      
      - name: Setup Visual Studio 2022
        uses: ilammy/msvc-dev-cmd@v1
        with:
          vsversion: '2022'
          arch: x64
          spectre: true
      
      - name: Install Unreal Engine 5.4
        uses: epicgames/unreal-engine-automation@latest
        with:
          engine-version: 5.4
      
      - name: Generate Project Files
        run: |
          $env:UE_FOLDER = $env:UE5_FOLDER
          if ($null -eq $env:UE_FOLDER) {
              $env:UE_FOLDER = "C:\Program Files\Epic Games\UE_5.4"
          }
          
          & "$env:UE_FOLDER\Engine\Build\BatchFiles\GenerateProjectFiles.bat" "${{ github.workspace }}\Aeterna.uproject"
      
      - name: Build Shipping Configuration
        run: |
          $env:UE_FOLDER = $env:UE5_FOLDER
          if ($null -eq $env:UE_FOLDER) {
              $env:UE_FOLDER = "C:\Program Files\Epic Games\UE_5.4"
          }
          
          & "$env:UE_FOLDER\Engine\Build\BatchFiles\Build.bat" `
            Aeterna `
            Win64 `
            Shipping `
            -Project="${{ github.workspace }}\Aeterna.uproject" `
            -NoGold
      
      - name: Package Standalone Game
        run: |
          $env:UE_FOLDER = $env:UE5_FOLDER
          if ($null -eq $env:UE_FOLDER) {
              $env:UE_FOLDER = "C:\Program Files\Epic Games\UE_5.4"
          }
          
          $packPath = "${{ github.workspace }}\Build\Windows\Packaged"
          New-Item -ItemType Directory -Path $packPath -Force | Out-Null
          
          & "$env:UE_FOLDER\Engine\Build\BatchFiles\RunUAT.bat" BuildCookRun `
            -Project="${{ github.workspace }}\Aeterna.uproject" `
            -NoP4 `
            -NoGold `
            -ClientConfig=Shipping `
            -ServerConfig=Shipping `
            -Build `
            -Cook `
            -Compressed `
            -Package `
            -TargetPlatform=Win64 `
            -UnversionedCookedContent `
            -CreatePhysicsAsset `
            -Pak `
            -ArchivePath="$packPath" `
            -CreateReleaseVersion="0.1.0" `
            -UnattendedMode
      
      - name: Prepare Executable
        run: |
          $sourceExe = Get-ChildItem -Recurse -Filter "AeternaGame-Win64-Shipping.exe" | Select-Object -First 1
          if ($null -eq $sourceExe) {
              throw "Could not find packaged executable"
          }
          
          $exePath = "${{ github.workspace }}\Build\Windows\Packaged\${{ env.GAME_NAME }}.exe"
          Copy-Item -Path $sourceExe.FullName -Destination $exePath -Force
          
          Write-Host "Executable ready: $exePath"
          Write-Host "Size: $('{0:N0}' -f ((Get-Item $exePath).Length / 1GB)) GB"
      
      - name: Create Release Package
        run: |
          $packDir = "${{ github.workspace }}\Build\Windows\Packaged"
          $sourceCode = "${{ github.workspace }}\Source"
          
          # Create source code archive
          if (Test-Path $sourceCode) {
              Compress-Archive -Path $sourceCode -DestinationPath "$packDir\Source_Code.zip" -Force
              Write-Host "Created Source_Code.zip"
          }
          
          # Create main package
          $exePath = "$packDir\${{ env.GAME_NAME }}.exe"
          if (Test-Path $exePath) {
              $files = @(
                  $exePath,
                  "$packDir\Source_Code.zip"
              )
              
              $releaseZip = "$packDir\${{ env.GAME_NAME }}.zip"
              Compress-Archive -Path $files -DestinationPath $releaseZip -Force
              
              $size = '{0:N0}' -f ((Get-Item $releaseZip).Length / 1GB)
              Write-Host "Created release package: ${{ env.GAME_NAME }}.zip ($size GB)"
          } else {
              throw "Executable not found at: $exePath"
          }
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: AETERNA_Day47_FirstContact
          path: ${{ github.workspace }}/Build/Windows/Packaged/${{ env.GAME_NAME }}.zip
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ github.workspace }}/Build/Windows/Packaged/${{ env.GAME_NAME }}.zip
          draft: false
          prerelease: false
          body_path: ${{ github.workspace }}/RELEASE_NOTES.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to Release
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: ready-for-release
          path: ${{ github.workspace }}/Build/Windows/Packaged/${{ env.GAME_NAME }}.zip

  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: build-windows
    if: always()
    
    steps:
      - name: Build Status Check
        run: |
          if [ "${{ needs.build-windows.result }}" == "success" ]; then
            echo "✅ Build completed successfully"
          else
            echo "❌ Build failed"
            exit 1
          fi
